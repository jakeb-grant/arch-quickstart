name: Build Arch Linux ISO

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'archiso/**'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      iso_name:
        description: 'Custom ISO name (optional)'
        required: false
        default: ''

env:
  ISO_NAME: ${{ github.event.inputs.iso_name || 'archlinux-custom' }}

jobs:
  # =============================================================================
  # Online ISO Build (Fast, smaller ISO, requires internet during installation)
  # =============================================================================
  build-online:
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize pacman keyring
        run: |
          pacman-key --init
          pacman-key --populate archlinux

      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso mkinitcpio-archiso grub dosfstools squashfs-tools libisoburn curl jq

      - name: Validate package lists
        run: |
          echo "Ensuring package databases are synchronized..."
          pacman -Sy

          INVALID_PACKAGES=""

          # Validate live ISO packages
          echo ""
          echo "Validating packages in archiso/packages.x86_64 (live ISO)..."
          while IFS= read -r package; do
            if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
              continue
            fi
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid package: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            else
              echo "✓ Valid package: $package"
            fi
          done < archiso/packages.x86_64

          # Validate target system packages
          echo ""
          echo "Validating packages in archiso/airootfs/root/target-packages.x86_64 (installed system)..."
          while IFS= read -r package; do
            if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
              continue
            fi
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid package: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            else
              echo "✓ Valid package: $package"
            fi
          done < archiso/airootfs/root/target-packages.x86_64

          if [[ -n "$INVALID_PACKAGES" ]]; then
            echo ""
            echo "ERROR: The following official packages were not found in the repositories:"
            echo "$INVALID_PACKAGES"
            exit 1
          fi

          echo ""
          echo "All official packages validated successfully!"

      - name: Build ISO
        run: |
          cd archiso
          mkarchiso -v -w /tmp/archiso-work -o /tmp/archiso-out .

      - name: Get ISO filename and rename
        id: iso-info
        run: |
          ISO_FILE=$(ls /tmp/archiso-out/*.iso 2>/dev/null | head -1)
          if [ -z "$ISO_FILE" ]; then
            echo "No ISO file found!"
            exit 1
          fi
          # Rename to indicate online variant
          NEW_NAME=$(basename "$ISO_FILE" .iso)-online.iso
          mv "$ISO_FILE" "/tmp/archiso-out/$NEW_NAME"
          ISO_SIZE=$(du -h "/tmp/archiso-out/$NEW_NAME" | cut -f1)
          echo "iso_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
          echo "Built ISO: $NEW_NAME ($ISO_SIZE)"

      - name: Generate checksums
        run: |
          cd /tmp/archiso-out
          sha256sum *.iso > SHA256SUMS
          sha512sum *.iso > SHA512SUMS
          cat SHA256SUMS

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-custom-iso-online
          path: |
            /tmp/archiso-out/*.iso
            /tmp/archiso-out/SHA256SUMS
            /tmp/archiso-out/SHA512SUMS
          retention-days: 7
          compression-level: 0

  # =============================================================================
  # Offline ISO Build (Slower, larger ISO, no internet required for installation)
  # =============================================================================
  build-offline:
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h /
          # Clean pacman cache
          pacman -Scc --noconfirm 2>/dev/null || true
          # Remove docs and unnecessary locale files
          rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/info/* 2>/dev/null || true
          rm -rf /usr/share/locale/* 2>/dev/null || true
          echo "Disk space after cleanup:"
          df -h /

      - name: Initialize pacman keyring
        run: |
          pacman-key --init
          pacman-key --populate archlinux

      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso mkinitcpio-archiso grub dosfstools squashfs-tools libisoburn curl jq

      - name: Validate package lists
        run: |
          echo "Ensuring package databases are synchronized..."
          pacman -Sy

          INVALID_PACKAGES=""

          # Validate live ISO packages
          echo ""
          echo "Validating packages in archiso/packages.x86_64 (live ISO)..."
          while IFS= read -r package; do
            if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
              continue
            fi
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid package: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            else
              echo "✓ Valid package: $package"
            fi
          done < archiso/packages.x86_64

          # Validate target system packages
          echo ""
          echo "Validating packages in archiso/airootfs/root/target-packages.x86_64 (installed system)..."
          while IFS= read -r package; do
            if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
              continue
            fi
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid package: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            else
              echo "✓ Valid package: $package"
            fi
          done < archiso/airootfs/root/target-packages.x86_64

          if [[ -n "$INVALID_PACKAGES" ]]; then
            echo ""
            echo "ERROR: The following official packages were not found in the repositories:"
            echo "$INVALID_PACKAGES"
            exit 1
          fi

          echo ""
          echo "All official packages validated successfully!"

          # Validate AUR packages
          echo ""
          echo "Validating packages in archiso/airootfs/root/aur-packages.x86_64 (AUR)..."

          AUR_PACKAGES=""
          while IFS= read -r package; do
            if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
              continue
            fi
            AUR_PACKAGES="$AUR_PACKAGES $package"
          done < archiso/airootfs/root/aur-packages.x86_64

          if [[ -n "$AUR_PACKAGES" ]]; then
            QUERY_ARGS=""
            for pkg in $AUR_PACKAGES; do
              QUERY_ARGS="${QUERY_ARGS}&arg[]=${pkg}"
            done
            QUERY_ARGS="${QUERY_ARGS:1}"

            AUR_RESPONSE=$(curl -s "https://aur.archlinux.org/rpc/v5/info?${QUERY_ARGS}")

            if ! echo "$AUR_RESPONSE" | jq -e '.type == "multiinfo"' > /dev/null 2>&1; then
              echo "ERROR: Failed to query AUR API"
              echo "$AUR_RESPONSE"
              exit 1
            fi

            FOUND_PACKAGES=$(echo "$AUR_RESPONSE" | jq -r '.results[].Name')

            INVALID_AUR=""
            for pkg in $AUR_PACKAGES; do
              if echo "$FOUND_PACKAGES" | grep -q "^${pkg}$"; then
                echo "✓ Valid AUR package: $pkg"
              else
                echo "❌ Invalid AUR package: $pkg"
                INVALID_AUR="$INVALID_AUR $pkg"
              fi
            done

            if [[ -n "$INVALID_AUR" ]]; then
              echo ""
              echo "ERROR: The following AUR packages were not found:"
              echo "$INVALID_AUR"
              exit 1
            fi

            echo ""
            echo "All AUR packages validated successfully!"
          fi

          echo ""
          echo "All package validation complete!"

      - name: Build offline package repository
        run: |
          echo "=========================================="
          echo "Building offline package repository"
          echo "=========================================="

          # Create build user for AUR packages (makepkg cannot run as root)
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          # Install additional build dependencies
          pacman -S --noconfirm --needed git base-devel sudo

          # Create directories
          mkdir -p /tmp/offline-repo
          mkdir -p /tmp/aur-build
          mkdir -p /tmp/blankdb/local
          chown builder:builder /tmp/aur-build

          # ===========================================
          # Download official packages with dependencies
          # ===========================================
          echo ""
          echo "Downloading official packages..."

          mapfile -t TARGET_PACKAGES < <(grep -v '^#' archiso/airootfs/root/target-packages.x86_64 | grep -v '^$')

          echo "Packages to download: ${#TARGET_PACKAGES[@]}"

          pacman -Syw --noconfirm --cachedir /tmp/offline-repo --dbpath /tmp/blankdb "${TARGET_PACKAGES[@]}"

          echo ""
          echo "Official packages downloaded: $(ls /tmp/offline-repo/*.pkg.tar.zst 2>/dev/null | wc -l)"

          # ===========================================
          # Build AUR packages using yay
          # ===========================================
          echo ""
          echo "Building AUR packages..."

          cd /tmp/aur-build

          # Step 1: Build and install yay-bin first
          echo ""
          echo "::group::Building yay-bin (AUR helper)"
          su -s /bin/bash builder -c "git clone https://aur.archlinux.org/yay-bin.git"
          cd yay-bin
          chown -R builder:builder .
          su -s /bin/bash builder -c "makepkg -s --noconfirm --skippgpcheck"
          pacman -U --noconfirm *.pkg.tar.zst
          cp *.pkg.tar.zst /tmp/offline-repo/
          cd /tmp/aur-build
          echo "::endgroup::"

          # Step 2: Read remaining AUR packages (excluding yay-bin)
          mapfile -t AUR_PACKAGES < <(grep -v '^#' "$GITHUB_WORKSPACE/archiso/airootfs/root/aur-packages.x86_64" | grep -v '^$' | grep -v '^yay-bin$')

          if [[ ${#AUR_PACKAGES[@]} -gt 0 ]]; then
            echo ""
            echo "::group::Installing AUR packages with yay"
            echo "Packages: ${AUR_PACKAGES[*]}"

            # Use yay to install all packages (handles dependency resolution)
            # This will fail the build if any package fails to install
            su -s /bin/bash builder -c "yay -S --noconfirm --needed ${AUR_PACKAGES[*]}"
            echo "::endgroup::"

            # Copy built AUR packages from yay's cache
            echo ""
            echo "Copying AUR packages to offline repository..."
            YAY_PKG_COUNT=$(find /home/builder/.cache/yay -name "*.pkg.tar.zst" 2>/dev/null | wc -l)
            if [[ "$YAY_PKG_COUNT" -eq 0 ]]; then
              echo "ERROR: No AUR packages found in yay cache!"
              exit 1
            fi
            echo "Found $YAY_PKG_COUNT packages in yay cache"
            cp /home/builder/.cache/yay/*/*.pkg.tar.zst /tmp/offline-repo/

            # Also copy any dependencies yay installed from official repos
            echo ""
            echo "Copying official repo dependencies installed by yay..."
            PACMAN_PKG_COUNT=$(find /var/cache/pacman/pkg -name "*.pkg.tar.zst" 2>/dev/null | wc -l)
            echo "Found $PACMAN_PKG_COUNT packages in pacman cache"
            if [[ "$PACMAN_PKG_COUNT" -gt 0 ]]; then
              cp -n /var/cache/pacman/pkg/*.pkg.tar.zst /tmp/offline-repo/ 2>/dev/null || true
            fi
          fi

          echo ""
          echo "AUR packages built successfully"

          # ===========================================
          # Create repository database
          # ===========================================
          echo ""
          echo "Creating repository database..."

          cd /tmp/offline-repo
          repo-add offline.db.tar.zst *.pkg.tar.zst

          echo ""
          echo "Repository database created"

          # ===========================================
          # Validate repository completeness
          # ===========================================
          echo ""
          echo "Validating offline repository completeness..."

          # Get list of packages in the repo
          REPO_PACKAGES=$(tar -tf offline.db.tar.zst | grep -E '^[^/]+/$' | sed 's|/||' | sed 's|-[^-]*-[^-]*$||')

          MISSING_PACKAGES=""

          # Check all target packages
          echo "Checking target packages..."
          while IFS= read -r pkg || [[ -n "$pkg" ]]; do
            [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
            if ! echo "$REPO_PACKAGES" | grep -qx "$pkg"; then
              echo "❌ Missing: $pkg"
              MISSING_PACKAGES="$MISSING_PACKAGES $pkg"
            fi
          done < "$GITHUB_WORKSPACE/archiso/airootfs/root/target-packages.x86_64"

          # Check all AUR packages
          echo "Checking AUR packages..."
          while IFS= read -r pkg || [[ -n "$pkg" ]]; do
            [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
            if ! echo "$REPO_PACKAGES" | grep -qx "$pkg"; then
              echo "❌ Missing: $pkg"
              MISSING_PACKAGES="$MISSING_PACKAGES $pkg"
            fi
          done < "$GITHUB_WORKSPACE/archiso/airootfs/root/aur-packages.x86_64"

          if [[ -n "$MISSING_PACKAGES" ]]; then
            echo ""
            echo "=========================================="
            echo "ERROR: Offline repository is incomplete!"
            echo "Missing packages:$MISSING_PACKAGES"
            echo "=========================================="
            exit 1
          fi

          echo "✓ All required packages present in offline repository"

          # ===========================================
          # Copy repository to airootfs
          # ===========================================
          echo ""
          echo "Copying repository to ISO airootfs..."

          mkdir -p "$GITHUB_WORKSPACE/archiso/airootfs/opt/offline-repo"
          cp /tmp/offline-repo/*.pkg.tar.zst "$GITHUB_WORKSPACE/archiso/airootfs/opt/offline-repo/"
          cp /tmp/offline-repo/offline.db* "$GITHUB_WORKSPACE/archiso/airootfs/opt/offline-repo/"
          cp /tmp/offline-repo/offline.files* "$GITHUB_WORKSPACE/archiso/airootfs/opt/offline-repo/"

          echo ""
          echo "=========================================="
          echo "Offline repository complete!"
          echo "=========================================="
          echo "Total packages: $(ls "$GITHUB_WORKSPACE/archiso/airootfs/opt/offline-repo/"*.pkg.tar.zst | wc -l)"
          echo "Repository size: $(du -sh "$GITHUB_WORKSPACE/archiso/airootfs/opt/offline-repo/" | cut -f1)"
          echo "=========================================="

          # ===========================================
          # Clean up to free disk space before ISO build
          # ===========================================
          echo ""
          echo "Cleaning up temporary files..."
          rm -rf /tmp/offline-repo
          rm -rf /tmp/aur-build
          rm -rf /tmp/blankdb
          rm -rf /home/builder/.cache/yay
          pacman -Scc --noconfirm 2>/dev/null || true
          echo "Disk space available:"
          df -h /

      - name: Build ISO
        run: |
          cd archiso
          mkarchiso -v -w /tmp/archiso-work -o /tmp/archiso-out .

      - name: Get ISO filename and rename
        id: iso-info
        run: |
          ISO_FILE=$(ls /tmp/archiso-out/*.iso 2>/dev/null | head -1)
          if [ -z "$ISO_FILE" ]; then
            echo "No ISO file found!"
            exit 1
          fi
          # Rename to indicate offline variant
          NEW_NAME=$(basename "$ISO_FILE" .iso)-offline.iso
          mv "$ISO_FILE" "/tmp/archiso-out/$NEW_NAME"
          ISO_SIZE=$(du -h "/tmp/archiso-out/$NEW_NAME" | cut -f1)
          echo "iso_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
          echo "Built ISO: $NEW_NAME ($ISO_SIZE)"

      - name: Generate checksums
        run: |
          cd /tmp/archiso-out
          sha256sum *.iso > SHA256SUMS
          sha512sum *.iso > SHA512SUMS
          cat SHA256SUMS

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-custom-iso-offline
          path: |
            /tmp/archiso-out/*.iso
            /tmp/archiso-out/SHA256SUMS
            /tmp/archiso-out/SHA512SUMS
          retention-days: 7
          compression-level: 0

  # =============================================================================
  # Create Release (runs after both builds complete, only on tag push)
  # =============================================================================
  release:
    runs-on: ubuntu-latest
    needs: [build-online, build-offline]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download online ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: archlinux-custom-iso-online
          path: release/online

      - name: Download offline ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: archlinux-custom-iso-offline
          path: release/offline

      - name: Combine checksums
        run: |
          cd release
          cat online/SHA256SUMS offline/SHA256SUMS > SHA256SUMS
          cat online/SHA512SUMS offline/SHA512SUMS > SHA512SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/online/*.iso
            release/offline/*.iso
            release/SHA256SUMS
            release/SHA512SUMS
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
