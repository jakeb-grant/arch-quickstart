name: Build Arch Linux ISO

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'archiso/**'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      iso_name:
        description: 'Custom ISO name (optional)'
        required: false
        default: ''
      dotfiles_repo:
        description: 'Dotfiles repo URL for offline ISO (optional, e.g., https://github.com/user/dotfiles)'
        required: false
        default: ''

env:
  ISO_NAME: ${{ github.event.inputs.iso_name || 'archlinux-custom' }}

jobs:
  # =============================================================================
  # Online ISO Build (Fast, smaller ISO, requires internet during installation)
  # =============================================================================
  build-online:
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize pacman keyring
        run: |
          pacman-key --init
          pacman-key --populate archlinux

      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso mkinitcpio-archiso grub dosfstools squashfs-tools libisoburn curl jq

      - name: Validate package lists
        run: |
          echo "Enabling multilib repository for lib32 package validation..."
          if ! grep -q '^\[multilib\]' /etc/pacman.conf; then
            echo -e '\n[multilib]\nInclude = /etc/pacman.d/mirrorlist' >> /etc/pacman.conf
          fi

          echo "Ensuring package databases are synchronized..."
          pacman -Sy

          INVALID_PACKAGES=""

          # Validate live ISO packages
          echo ""
          echo "Validating packages in archiso/packages.x86_64 (live ISO)..."
          while IFS= read -r package; do
            if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
              continue
            fi
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid package: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            else
              echo "✓ Valid package: $package"
            fi
          done < archiso/packages.x86_64

          # Validate target system packages
          echo ""
          echo "Validating packages in archiso/airootfs/root/target-packages.x86_64 (installed system)..."
          while IFS= read -r package; do
            if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
              continue
            fi
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid package: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            else
              echo "✓ Valid package: $package"
            fi
          done < archiso/airootfs/root/target-packages.x86_64

          if [[ -n "$INVALID_PACKAGES" ]]; then
            echo ""
            echo "ERROR: The following official packages were not found in the repositories:"
            echo "$INVALID_PACKAGES"
            exit 1
          fi

          echo ""
          echo "All official packages validated successfully!"

          # Validate AUR packages
          echo ""
          echo "Validating packages in archiso/airootfs/root/aur-packages.x86_64 (AUR)..."

          AUR_PACKAGES=""
          while IFS= read -r package; do
            if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
              continue
            fi
            AUR_PACKAGES="$AUR_PACKAGES $package"
          done < archiso/airootfs/root/aur-packages.x86_64

          if [[ -n "$AUR_PACKAGES" ]]; then
            QUERY_ARGS=""
            for pkg in $AUR_PACKAGES; do
              QUERY_ARGS="${QUERY_ARGS}&arg[]=${pkg}"
            done
            QUERY_ARGS="${QUERY_ARGS:1}"

            AUR_RESPONSE=$(curl -s "https://aur.archlinux.org/rpc/v5/info?${QUERY_ARGS}")

            if ! echo "$AUR_RESPONSE" | jq -e '.type == "multiinfo"' > /dev/null 2>&1; then
              echo "ERROR: Failed to query AUR API"
              echo "$AUR_RESPONSE"
              exit 1
            fi

            FOUND_PACKAGES=$(echo "$AUR_RESPONSE" | jq -r '.results[].Name')

            INVALID_AUR=""
            for pkg in $AUR_PACKAGES; do
              if echo "$FOUND_PACKAGES" | grep -q "^${pkg}$"; then
                echo "✓ Valid AUR package: $pkg"
              else
                echo "❌ Invalid AUR package: $pkg"
                INVALID_AUR="$INVALID_AUR $pkg"
              fi
            done

            if [[ -n "$INVALID_AUR" ]]; then
              echo ""
              echo "ERROR: The following AUR packages were not found:"
              echo "$INVALID_AUR"
              exit 1
            fi

            echo ""
            echo "All AUR packages validated successfully!"
          fi

          echo ""
          echo "All package validation complete!"

      - name: Build ISO
        run: |
          cd archiso
          mkarchiso -v -w /tmp/archiso-work -o /tmp/archiso-out .

      - name: Get ISO filename and rename
        id: iso-info
        run: |
          ISO_FILE=$(ls /tmp/archiso-out/*.iso 2>/dev/null | head -1)
          if [ -z "$ISO_FILE" ]; then
            echo "No ISO file found!"
            exit 1
          fi
          # Rename to indicate online variant
          NEW_NAME=$(basename "$ISO_FILE" .iso)-online.iso
          mv "$ISO_FILE" "/tmp/archiso-out/$NEW_NAME"
          ISO_SIZE=$(du -h "/tmp/archiso-out/$NEW_NAME" | cut -f1)
          echo "iso_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
          echo "Built ISO: $NEW_NAME ($ISO_SIZE)"

      - name: Generate checksums
        run: |
          cd /tmp/archiso-out
          sha256sum *.iso > SHA256SUMS
          sha512sum *.iso > SHA512SUMS
          cat SHA256SUMS

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-custom-iso-online
          path: |
            /tmp/archiso-out/*.iso
            /tmp/archiso-out/SHA256SUMS
            /tmp/archiso-out/SHA512SUMS
          retention-days: 7
          compression-level: 0

  # =============================================================================
  # Offline ISO Build (Slower, larger ISO, no internet required for installation)
  # =============================================================================
  build-offline:
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository

    steps:
      # Free up disk space on the runner BEFORE starting the container
      # This is critical for the offline ISO which needs ~8GB for packages + squashfs
      - name: Free up disk space on runner
        run: |
          echo "Disk space before cleanup:"
          df -h /

          # Remove large pre-installed components we don't need
          echo "Removing Android SDK (~8GB)..."
          sudo rm -rf /usr/local/lib/android || true

          echo "Removing .NET (~2GB)..."
          sudo rm -rf /usr/share/dotnet || true

          echo "Removing Haskell..."
          sudo rm -rf /opt/ghc /usr/local/.ghcup || true

          echo "Removing Swift..."
          sudo rm -rf /usr/share/swift || true

          echo "Removing Go..."
          sudo rm -rf /usr/local/go || true

          echo "Removing CodeQL..."
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true

          echo "Removing pre-installed browsers..."
          sudo rm -rf /opt/google /opt/microsoft || true

          echo "Removing docs and cached packages..."
          sudo rm -rf /var/cache/apt/archives/* || true
          sudo rm -rf /usr/share/doc/* /usr/share/man/* || true

          # Docker images we don't need
          echo "Removing unused Docker images..."
          docker image prune -af 2>/dev/null || true

          echo ""
          echo "Disk space after cleanup:"
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build in Arch Linux container
        run: |
          # Run the entire build process in a single container
          # Mount workspace to /workspace inside container
          docker run --rm --privileged \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -v "/tmp:/tmp" \
            -e GITHUB_WORKSPACE=/workspace \
            -e DOTFILES_REPO="${{ github.event.inputs.dotfiles_repo }}" \
            -w /workspace \
            archlinux:latest bash -c '
          set -e

          echo "=========================================="
          echo "Initializing Arch Linux environment"
          echo "=========================================="

          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso mkinitcpio-archiso grub dosfstools squashfs-tools libisoburn curl jq git base-devel sudo

          echo ""
          echo "Disk space available:"
          df -h /

          echo ""
          echo "=========================================="
          echo "Validating package lists"
          echo "=========================================="

          # Enable multilib for lib32 package validation
          if ! grep -q "^\[multilib\]" /etc/pacman.conf; then
            echo -e "\n[multilib]\nInclude = /etc/pacman.d/mirrorlist" >> /etc/pacman.conf
          fi
          pacman -Sy

          INVALID_PACKAGES=""

          echo ""
          echo "Validating live ISO packages..."
          while IFS= read -r package; do
            [[ -z "$package" ]] || [[ "$package" =~ ^# ]] && continue
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            fi
          done < archiso/packages.x86_64

          echo ""
          echo "Validating target system packages..."
          while IFS= read -r package; do
            [[ -z "$package" ]] || [[ "$package" =~ ^# ]] && continue
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            fi
          done < archiso/airootfs/root/target-packages.x86_64

          echo ""
          echo "Validating setup script packages..."
          while IFS= read -r package; do
            [[ -z "$package" ]] || [[ "$package" =~ ^# ]] && continue
            if ! pacman -Si "$package" &>/dev/null; then
              echo "❌ Invalid: $package"
              INVALID_PACKAGES="$INVALID_PACKAGES $package"
            fi
          done < archiso/airootfs/root/setup-packages.x86_64

          if [[ -n "$INVALID_PACKAGES" ]]; then
            echo "ERROR: Invalid packages:$INVALID_PACKAGES"
            exit 1
          fi
          echo "✓ All official packages validated"

          # Validate AUR packages via API
          echo ""
          echo "Validating AUR packages..."
          AUR_PACKAGES=""
          while IFS= read -r package; do
            [[ -z "$package" ]] || [[ "$package" =~ ^# ]] && continue
            AUR_PACKAGES="$AUR_PACKAGES $package"
          done < archiso/airootfs/root/aur-packages.x86_64

          if [[ -n "$AUR_PACKAGES" ]]; then
            QUERY_ARGS=""
            for pkg in $AUR_PACKAGES; do
              QUERY_ARGS="${QUERY_ARGS}&arg[]=${pkg}"
            done
            QUERY_ARGS="${QUERY_ARGS:1}"
            AUR_RESPONSE=$(curl -s "https://aur.archlinux.org/rpc/v5/info?${QUERY_ARGS}")
            FOUND_PACKAGES=$(echo "$AUR_RESPONSE" | jq -r ".results[].Name")
            INVALID_AUR=""
            for pkg in $AUR_PACKAGES; do
              if ! echo "$FOUND_PACKAGES" | grep -qx "$pkg"; then
                echo "❌ Invalid AUR: $pkg"
                INVALID_AUR="$INVALID_AUR $pkg"
              fi
            done
            if [[ -n "$INVALID_AUR" ]]; then
              echo "ERROR: Invalid AUR packages:$INVALID_AUR"
              exit 1
            fi
            echo "✓ All AUR packages validated"
          fi

          echo ""
          echo "=========================================="
          echo "Building offline package repository"
          echo "=========================================="

          # Create build user for AUR packages
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          mkdir -p /tmp/offline-repo
          mkdir -p /tmp/aur-build
          mkdir -p /tmp/blankdb/local
          chown builder:builder /tmp/aur-build

          # Download official packages
          echo ""
          echo "Downloading target packages..."
          mapfile -t TARGET_PACKAGES < <(grep -v "^#" archiso/airootfs/root/target-packages.x86_64 | grep -v "^$")
          pacman -Syw --noconfirm --cachedir /tmp/offline-repo --dbpath /tmp/blankdb "${TARGET_PACKAGES[@]}"

          # Sync multilib to blankdb
          pacman -Sy --dbpath /tmp/blankdb

          echo ""
          echo "Downloading setup packages (GPU drivers, etc.)..."
          mapfile -t SETUP_PACKAGES < <(grep -v "^#" archiso/airootfs/root/setup-packages.x86_64 | grep -v "^$")
          pacman -Syw --noconfirm --cachedir /tmp/offline-repo --dbpath /tmp/blankdb "${SETUP_PACKAGES[@]}"

          rm -rf /tmp/blankdb
          pacman -Scc --noconfirm 2>/dev/null || true
          echo "Official packages downloaded: $(ls /tmp/offline-repo/*.pkg.tar.zst 2>/dev/null | wc -l)"

          # Build AUR packages
          echo ""
          echo "Building AUR packages..."
          cd /tmp/aur-build

          echo "::group::Building yay-bin"
          su -s /bin/bash builder -c "git clone https://aur.archlinux.org/yay-bin.git"
          cd yay-bin
          chown -R builder:builder .
          su -s /bin/bash builder -c "makepkg -s --noconfirm --skippgpcheck"
          pacman -U --noconfirm *.pkg.tar.zst
          cp *.pkg.tar.zst /tmp/offline-repo/
          cd /tmp/aur-build
          echo "::endgroup::"

          mapfile -t AUR_PACKAGES < <(grep -v "^#" /workspace/archiso/airootfs/root/aur-packages.x86_64 | grep -v "^$" | grep -v "^yay-bin$")

          if [[ ${#AUR_PACKAGES[@]} -gt 0 ]]; then
            echo "::group::Installing AUR packages with yay"
            su -s /bin/bash builder -c "yay -S --noconfirm --needed ${AUR_PACKAGES[*]}"
            echo "::endgroup::"

            cp /home/builder/.cache/yay/*/*.pkg.tar.zst /tmp/offline-repo/
            cp -n /var/cache/pacman/pkg/*.pkg.tar.zst /tmp/offline-repo/ 2>/dev/null || true
          fi

          rm -rf /home/builder/.cache/yay /tmp/aur-build
          pacman -Scc --noconfirm 2>/dev/null || true

          # Create repository database
          echo ""
          echo "Creating repository database..."
          cd /tmp/offline-repo
          repo-add offline.db.tar.zst *.pkg.tar.zst

          # Validate completeness
          echo ""
          echo "Validating repository completeness..."
          REPO_PACKAGES=$(tar --wildcards -xf offline.db.tar.zst -O "*/desc" | awk "/^%NAME%$/{getline; print}")
          MISSING=""

          while IFS= read -r pkg || [[ -n "$pkg" ]]; do
            [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
            echo "$REPO_PACKAGES" | grep -qx "$pkg" || MISSING="$MISSING $pkg"
          done < /workspace/archiso/airootfs/root/target-packages.x86_64

          while IFS= read -r pkg || [[ -n "$pkg" ]]; do
            [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
            echo "$REPO_PACKAGES" | grep -qx "$pkg" || MISSING="$MISSING $pkg"
          done < /workspace/archiso/airootfs/root/aur-packages.x86_64

          while IFS= read -r pkg || [[ -n "$pkg" ]]; do
            [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
            echo "$REPO_PACKAGES" | grep -qx "$pkg" || MISSING="$MISSING $pkg"
          done < /workspace/archiso/airootfs/root/setup-packages.x86_64

          if [[ -n "$MISSING" ]]; then
            echo "ERROR: Missing packages:$MISSING"
            exit 1
          fi
          echo "✓ All packages present"

          # Move to airootfs
          echo ""
          echo "Moving repository to airootfs..."
          mkdir -p /workspace/archiso/airootfs/opt/offline-repo
          mv /tmp/offline-repo/*.pkg.tar.zst /workspace/archiso/airootfs/opt/offline-repo/
          mv /tmp/offline-repo/offline.db* /workspace/archiso/airootfs/opt/offline-repo/
          mv /tmp/offline-repo/offline.files* /workspace/archiso/airootfs/opt/offline-repo/
          rm -rf /tmp/offline-repo

          echo "Repository size: $(du -sh /workspace/archiso/airootfs/opt/offline-repo/ | cut -f1)"
          echo "Disk space available: $(df -h / | tail -1 | awk "{print \$4}")"

          # Clone dotfiles (optional)
          if [[ -n "$DOTFILES_REPO" ]]; then
            echo ""
            echo "Cloning dotfiles from: $DOTFILES_REPO"
            git clone --depth 1 "$DOTFILES_REPO" /workspace/archiso/airootfs/opt/dotfiles || true
          elif [[ -f /workspace/archiso/dotfiles.conf ]]; then
            source /workspace/archiso/dotfiles.conf
            if [[ -n "$DOTFILES_REPO" ]]; then
              echo ""
              echo "Cloning dotfiles from config: $DOTFILES_REPO"
              git clone --depth 1 "$DOTFILES_REPO" /workspace/archiso/airootfs/opt/dotfiles || true
            fi
          fi

          echo ""
          echo "=========================================="
          echo "Building ISO"
          echo "=========================================="
          df -h /

          cd /workspace/archiso
          mkarchiso -v -w /tmp/archiso-work -o /tmp/archiso-out .

          echo ""
          echo "=========================================="
          echo "ISO build complete!"
          echo "=========================================="
          ls -lh /tmp/archiso-out/
          '

      - name: Get ISO filename and rename
        id: iso-info
        run: |
          ISO_FILE=$(ls /tmp/archiso-out/*.iso 2>/dev/null | head -1)
          if [ -z "$ISO_FILE" ]; then
            echo "No ISO file found!"
            exit 1
          fi
          # Rename to indicate offline variant
          NEW_NAME=$(basename "$ISO_FILE" .iso)-offline.iso
          mv "$ISO_FILE" "/tmp/archiso-out/$NEW_NAME"
          ISO_SIZE=$(du -h "/tmp/archiso-out/$NEW_NAME" | cut -f1)
          echo "iso_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
          echo "Built ISO: $NEW_NAME ($ISO_SIZE)"

      - name: Generate checksums
        run: |
          cd /tmp/archiso-out
          sha256sum *.iso > SHA256SUMS
          sha512sum *.iso > SHA512SUMS
          cat SHA256SUMS

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-custom-iso-offline
          path: |
            /tmp/archiso-out/*.iso
            /tmp/archiso-out/SHA256SUMS
            /tmp/archiso-out/SHA512SUMS
          retention-days: 7
          compression-level: 0

  # =============================================================================
  # Create Release (runs after both builds complete, only on tag push)
  # =============================================================================
  release:
    runs-on: ubuntu-latest
    needs: [build-online, build-offline]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download online ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: archlinux-custom-iso-online
          path: release/online

      - name: Download offline ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: archlinux-custom-iso-offline
          path: release/offline

      - name: Combine checksums
        run: |
          cd release
          cat online/SHA256SUMS offline/SHA256SUMS > SHA256SUMS
          cat online/SHA512SUMS offline/SHA512SUMS > SHA512SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/online/*.iso
            release/offline/*.iso
            release/SHA256SUMS
            release/SHA512SUMS
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
