name: Build Arch Linux ISO

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'archiso/**'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      iso_name:
        description: 'Custom ISO name (optional)'
        required: false
        default: ''
      dotfiles_repo:
        description: 'Dotfiles repo URL for offline ISO (optional, e.g., https://github.com/user/dotfiles)'
        required: false
        default: ''

env:
  ISO_NAME: ${{ github.event.inputs.iso_name || 'archlinux-custom' }}

jobs:
  # =============================================================================
  # Online ISO Build (Fast, smaller ISO, requires internet during installation)
  # =============================================================================
  build-online:
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize pacman keyring
        run: |
          pacman-key --init
          pacman-key --populate archlinux

      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso mkinitcpio-archiso grub dosfstools squashfs-tools libisoburn curl jq

      - name: Validate package lists
        run: .github/scripts/validate-packages.sh

      - name: Build ISO
        run: |
          cd archiso
          mkarchiso -v -w /tmp/archiso-work -o /tmp/archiso-out .

      - name: Get ISO filename and rename
        id: iso-info
        run: |
          ISO_FILE=$(ls /tmp/archiso-out/*.iso 2>/dev/null | head -1)
          if [ -z "$ISO_FILE" ]; then
            echo "No ISO file found!"
            exit 1
          fi
          # Rename to indicate online variant
          NEW_NAME=$(basename "$ISO_FILE" .iso)-online.iso
          mv "$ISO_FILE" "/tmp/archiso-out/$NEW_NAME"
          ISO_SIZE=$(du -h "/tmp/archiso-out/$NEW_NAME" | cut -f1)
          echo "iso_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
          echo "Built ISO: $NEW_NAME ($ISO_SIZE)"

      - name: Generate checksums
        run: |
          cd /tmp/archiso-out
          sha256sum *.iso > SHA256SUMS
          sha512sum *.iso > SHA512SUMS
          cat SHA256SUMS

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-custom-iso-online
          path: |
            /tmp/archiso-out/*.iso
            /tmp/archiso-out/SHA256SUMS
            /tmp/archiso-out/SHA512SUMS
          retention-days: 7
          compression-level: 0

  # =============================================================================
  # Offline ISO Build (Slower, larger ISO, no internet required for installation)
  # =============================================================================
  build-offline:
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository

    steps:
      # Free up disk space on the runner BEFORE starting the container
      # This is critical for the offline ISO which needs ~8GB for packages + squashfs
      - name: Free up disk space on runner
        run: |
          echo "Disk space before cleanup:"
          df -h /

          # Remove large pre-installed components we don't need
          echo "Removing Android SDK (~8GB)..."
          sudo rm -rf /usr/local/lib/android || true

          echo "Removing .NET (~2GB)..."
          sudo rm -rf /usr/share/dotnet || true

          echo "Removing Haskell..."
          sudo rm -rf /opt/ghc /usr/local/.ghcup || true

          echo "Removing Swift..."
          sudo rm -rf /usr/share/swift || true

          echo "Removing Go..."
          sudo rm -rf /usr/local/go || true

          echo "Removing CodeQL..."
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true

          echo "Removing pre-installed browsers..."
          sudo rm -rf /opt/google /opt/microsoft || true

          echo "Removing docs and cached packages..."
          sudo rm -rf /var/cache/apt/archives/* || true
          sudo rm -rf /usr/share/doc/* /usr/share/man/* || true

          # Docker images we don't need
          echo "Removing unused Docker images..."
          docker image prune -af 2>/dev/null || true

          echo ""
          echo "Disk space after cleanup:"
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start Arch Linux container
        run: |
          docker run -d --name archbuild --privileged \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -v "/tmp:/tmp" \
            -e DOTFILES_REPO="${{ github.event.inputs.dotfiles_repo }}" \
            -w /workspace \
            archlinux:latest sleep infinity

      - name: Initialize Arch Linux environment
        run: |
          docker exec archbuild bash -c '
            pacman-key --init
            pacman-key --populate archlinux
            pacman -Syu --noconfirm
            pacman -S --noconfirm archiso mkinitcpio-archiso grub dosfstools squashfs-tools libisoburn curl jq git base-devel sudo
            echo "Disk space available:"
            df -h /
          '

      - name: Validate package lists
        run: |
          docker exec archbuild bash -c '
            .github/scripts/validate-packages.sh --include-setup-packages
          '

      - name: Build offline package repository
        run: |
          docker exec archbuild bash -c '
            set -e

            echo "=========================================="
            echo "Building offline package repository"
            echo "=========================================="

            # Create build user for AUR packages
            useradd -m builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

            mkdir -p /tmp/offline-repo
            mkdir -p /tmp/aur-build
            mkdir -p /tmp/blankdb/local
            chown builder:builder /tmp/aur-build

            # Ensure multilib is enabled (validation script already did this, but ensure for downloads)
            if ! grep -q "^\[multilib\]" /etc/pacman.conf; then
              echo -e "\n[multilib]\nInclude = /etc/pacman.d/mirrorlist" >> /etc/pacman.conf
            fi

            # Download official packages
            echo ""
            echo "Downloading target packages..."
            mapfile -t TARGET_PACKAGES < <(grep -v "^#" archiso/airootfs/root/target-packages.x86_64 | grep -v "^$")
            pacman -Syw --noconfirm --cachedir /tmp/offline-repo --dbpath /tmp/blankdb "${TARGET_PACKAGES[@]}"

            # Sync multilib to blankdb
            pacman -Sy --dbpath /tmp/blankdb

            echo ""
            echo "Downloading setup packages (GPU drivers, etc.)..."
            mapfile -t SETUP_PACKAGES < <(grep -v "^#" archiso/airootfs/root/setup-packages.x86_64 | grep -v "^$")
            pacman -Syw --noconfirm --cachedir /tmp/offline-repo --dbpath /tmp/blankdb "${SETUP_PACKAGES[@]}"

            rm -rf /tmp/blankdb
            pacman -Scc --noconfirm 2>/dev/null || true
            echo "Official packages downloaded: $(ls /tmp/offline-repo/*.pkg.tar.zst 2>/dev/null | wc -l)"

            # Build AUR packages
            echo ""
            echo "Building AUR packages..."
            cd /tmp/aur-build

            echo "::group::Building yay-bin"
            su -s /bin/bash builder -c "git clone https://aur.archlinux.org/yay-bin.git"
            cd yay-bin
            chown -R builder:builder .
            su -s /bin/bash builder -c "makepkg -s --noconfirm --skippgpcheck"
            pacman -U --noconfirm *.pkg.tar.zst
            cp *.pkg.tar.zst /tmp/offline-repo/
            cd /tmp/aur-build
            echo "::endgroup::"

            mapfile -t AUR_PACKAGES < <(grep -v "^#" /workspace/archiso/airootfs/root/aur-packages.x86_64 | grep -v "^$" | grep -v "^yay-bin$")

            if [[ ${#AUR_PACKAGES[@]} -gt 0 ]]; then
              echo "::group::Installing AUR packages with yay"
              su -s /bin/bash builder -c "yay -S --noconfirm --needed ${AUR_PACKAGES[*]}"
              echo "::endgroup::"

              cp /home/builder/.cache/yay/*/*.pkg.tar.zst /tmp/offline-repo/
              cp -n /var/cache/pacman/pkg/*.pkg.tar.zst /tmp/offline-repo/ 2>/dev/null || true
            fi

            # Build setup-script AUR packages (not auto-installed, used by nvidia-setup etc.)
            # These are kept separate to prevent conflicts (e.g., nvidia-580xx vs nvidia-open)
            SETUP_AUR_FILE="/workspace/archiso/airootfs/root/setup-aur-packages.x86_64"
            if [[ -f "$SETUP_AUR_FILE" ]]; then
              mapfile -t SETUP_AUR_PACKAGES < <(grep -v "^#" "$SETUP_AUR_FILE" | grep -v "^$")
              if [[ ${#SETUP_AUR_PACKAGES[@]} -gt 0 ]]; then
                echo ""
                echo "Building setup-script AUR packages..."
                echo "::group::Building setup AUR packages with yay"
                su -s /bin/bash builder -c "yay -S --noconfirm --needed ${SETUP_AUR_PACKAGES[*]}"
                echo "::endgroup::"

                # Copy built packages to offline repo
                cp /home/builder/.cache/yay/*/*.pkg.tar.zst /tmp/offline-repo/ 2>/dev/null || true
                cp -n /var/cache/pacman/pkg/*.pkg.tar.zst /tmp/offline-repo/ 2>/dev/null || true
              fi
            fi

            rm -rf /home/builder/.cache/yay /tmp/aur-build
            pacman -Scc --noconfirm 2>/dev/null || true

            # Create repository database
            echo ""
            echo "Creating repository database..."
            cd /tmp/offline-repo
            repo-add offline.db.tar.zst *.pkg.tar.zst

            # Validate completeness
            echo ""
            echo "Validating repository completeness..."
            REPO_PACKAGES=$(tar --wildcards -xf offline.db.tar.zst -O "*/desc" | awk "/^%NAME%$/{getline; print}")
            MISSING=""

            while IFS= read -r pkg || [[ -n "$pkg" ]]; do
              [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
              echo "$REPO_PACKAGES" | grep -qx "$pkg" || MISSING="$MISSING $pkg"
            done < /workspace/archiso/airootfs/root/target-packages.x86_64

            while IFS= read -r pkg || [[ -n "$pkg" ]]; do
              [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
              echo "$REPO_PACKAGES" | grep -qx "$pkg" || MISSING="$MISSING $pkg"
            done < /workspace/archiso/airootfs/root/aur-packages.x86_64

            while IFS= read -r pkg || [[ -n "$pkg" ]]; do
              [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
              echo "$REPO_PACKAGES" | grep -qx "$pkg" || MISSING="$MISSING $pkg"
            done < /workspace/archiso/airootfs/root/setup-packages.x86_64

            # Validate setup-aur-packages (legacy NVIDIA drivers, etc.)
            if [[ -f /workspace/archiso/airootfs/root/setup-aur-packages.x86_64 ]]; then
              while IFS= read -r pkg || [[ -n "$pkg" ]]; do
                [[ -z "$pkg" ]] || [[ "$pkg" =~ ^# ]] && continue
                echo "$REPO_PACKAGES" | grep -qx "$pkg" || MISSING="$MISSING $pkg"
              done < /workspace/archiso/airootfs/root/setup-aur-packages.x86_64
            fi

            if [[ -n "$MISSING" ]]; then
              echo "ERROR: Missing packages:$MISSING"
              exit 1
            fi
            echo "âœ“ All packages present"

            # Move to airootfs
            echo ""
            echo "Moving repository to airootfs..."
            mkdir -p /workspace/archiso/airootfs/opt/offline-repo
            mv /tmp/offline-repo/*.pkg.tar.zst /workspace/archiso/airootfs/opt/offline-repo/
            mv /tmp/offline-repo/offline.db* /workspace/archiso/airootfs/opt/offline-repo/
            mv /tmp/offline-repo/offline.files* /workspace/archiso/airootfs/opt/offline-repo/
            rm -rf /tmp/offline-repo

            echo ""
            echo "=========================================="
            echo "Offline repository complete!"
            echo "=========================================="
            echo "Repository size: $(du -sh /workspace/archiso/airootfs/opt/offline-repo/ | cut -f1)"
            echo "Disk space available: $(df -h / | tail -1 | awk "{print \$4}")"
          '

      - name: Clone dotfiles repository (optional)
        run: |
          docker exec archbuild bash -c '
            DOTFILES_REPO="${DOTFILES_REPO:-}"

            if [[ -z "$DOTFILES_REPO" ]] && [[ -f /workspace/archiso/dotfiles.conf ]]; then
              source /workspace/archiso/dotfiles.conf
            fi

            if [[ -z "$DOTFILES_REPO" ]]; then
              echo "No dotfiles repository specified, skipping..."
              exit 0
            fi

            echo "Cloning dotfiles from: $DOTFILES_REPO"
            git clone --depth 1 "$DOTFILES_REPO" /workspace/archiso/airootfs/opt/dotfiles || true
          '

      - name: Build ISO
        run: |
          docker exec archbuild bash -c '
            echo "=========================================="
            echo "Building ISO"
            echo "=========================================="
            df -h /

            cd /workspace/archiso
            mkarchiso -v -w /tmp/archiso-work -o /tmp/archiso-out .

            echo ""
            echo "=========================================="
            echo "ISO build complete!"
            echo "=========================================="

            # Rename ISO to indicate offline variant
            cd /tmp/archiso-out
            ISO_FILE=$(ls *.iso 2>/dev/null | head -1)
            if [ -z "$ISO_FILE" ]; then
              echo "No ISO file found!"
              exit 1
            fi
            NEW_NAME="${ISO_FILE%.iso}-offline.iso"
            mv "$ISO_FILE" "$NEW_NAME"
            echo "Renamed: $ISO_FILE -> $NEW_NAME"

            # Generate checksums
            echo ""
            echo "Generating checksums..."
            sha256sum *.iso > SHA256SUMS
            sha512sum *.iso > SHA512SUMS
            cat SHA256SUMS

            echo ""
            ls -lh /tmp/archiso-out/
          '

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-custom-iso-offline
          path: |
            /tmp/archiso-out/*.iso
            /tmp/archiso-out/SHA256SUMS
            /tmp/archiso-out/SHA512SUMS
          retention-days: 7
          compression-level: 0

      - name: Cleanup container
        if: always()
        run: docker rm -f archbuild 2>/dev/null || true

  # =============================================================================
  # Create Release (runs after both builds complete, only on tag push)
  # =============================================================================
  release:
    runs-on: ubuntu-latest
    needs: [build-online, build-offline]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download online ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: archlinux-custom-iso-online
          path: release/online

      - name: Download offline ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: archlinux-custom-iso-offline
          path: release/offline

      - name: Combine checksums
        run: |
          cd release
          cat online/SHA256SUMS offline/SHA256SUMS > SHA256SUMS
          cat online/SHA512SUMS offline/SHA512SUMS > SHA512SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/online/*.iso
            release/offline/*.iso
            release/SHA256SUMS
            release/SHA512SUMS
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
