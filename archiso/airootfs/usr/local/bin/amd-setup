#!/usr/bin/env bash
# ==============================================================================
# AMD GPU Setup Script for Arch Linux
# ==============================================================================
# Installs AMD GPU drivers and Vulkan support for Hyprland.
# AMD GPUs use the open-source AMDGPU/Mesa stack.
#
# This script is for:
# - Standalone AMD discrete GPUs (RX series, etc.)
# - AMD APUs (Ryzen with integrated Radeon)
#
# If you have AMD iGPU + NVIDIA dGPU, use nvidia-setup instead!
#
# Environment variables for chroot-aware operation:
#   CHROOT_TARGET   - Target mount point (e.g., "/mnt") for installer mode
#   CHROOT_USER     - Username to configure (for hyprland.conf)
#   NONINTERACTIVE  - Skip confirmation prompts when set to "1"
#   DETECTED_AMD    - Pre-detected AMD GPU info (skips detection)
#   DETECTED_NVIDIA - Pre-detected NVIDIA GPU info (for hybrid warning)
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
header() { echo -e "\n${CYAN}=== $1 ===${NC}\n"; }

# =============================================================================
# Chroot-aware helper functions
# =============================================================================

run_cmd() {
    if [[ -n "$CHROOT_TARGET" ]]; then
        arch-chroot "$CHROOT_TARGET" "$@"
    else
        sudo "$@"
    fi
}

pkg_install() {
    run_cmd pacman -S --needed --noconfirm "$@"
}

target_path() {
    echo "${CHROOT_TARGET}$1"
}

get_user_home() {
    if [[ -n "$CHROOT_USER" ]]; then
        echo "${CHROOT_TARGET}/home/$CHROOT_USER"
    elif [[ -n "$SUDO_USER" ]]; then
        echo "/home/$SUDO_USER"
    else
        echo "$HOME"
    fi
}

# ==============================================================================
# GPU Detection
# ==============================================================================
header "Detecting Graphics Hardware"

# Use pre-detected GPUs if provided, otherwise detect
if [[ -z "$DETECTED_AMD" ]]; then
    ALL_GPUS=$(lspci | grep -iE 'vga|3d|display' || true)
    DETECTED_AMD=$(echo "$ALL_GPUS" | grep -iE 'amd|radeon|ati' | head -1 || true)
    DETECTED_NVIDIA=$(echo "$ALL_GPUS" | grep -i 'nvidia' | head -1 || true)
    DETECTED_INTEL=$(echo "$ALL_GPUS" | grep -iE 'intel.*(graphics|hd|uhd|iris|xe)' | head -1 || true)
fi

# --- Check for hybrid setup with NVIDIA ---
if [[ -n "$DETECTED_NVIDIA" ]] && [[ "$NONINTERACTIVE" != "1" ]]; then
    echo ""
    warn "NVIDIA GPU detected alongside AMD!"
    echo ""
    echo "Detected GPUs:"
    echo "  AMD:    $DETECTED_AMD"
    echo "  NVIDIA: $DETECTED_NVIDIA"
    echo ""
    warn "For AMD iGPU + NVIDIA dGPU (hybrid graphics):"
    warn "  Run 'nvidia-setup' instead - it handles hybrid configurations."
    echo ""
    warn "This script (amd-setup) is only for standalone AMD systems."
    echo ""
    read -p "Continue with AMD-only setup anyway? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        info "Run 'nvidia-setup' for hybrid graphics configuration."
        exit 0
    fi
fi

# --- Validate AMD GPU exists ---
if [[ -z "$DETECTED_AMD" ]]; then
    echo ""
    warn "No AMD GPU detected!"
    echo ""
    echo "Detected GPUs:"
    lspci | grep -iE 'vga|3d|display' | sed 's/^/  /' || echo "  None found"
    echo ""

    if [[ -n "$DETECTED_NVIDIA" ]]; then
        info "NVIDIA GPU detected. Run 'nvidia-setup' instead."
    elif [[ -n "$DETECTED_INTEL" ]]; then
        info "Intel GPU detected. Run 'intel-setup' instead."
    fi
    exit 1
fi

# --- Display detected hardware ---
info "AMD GPU detected:"
echo "  $DETECTED_AMD"

# Determine GPU type
GPU_TYPE="discrete"
if echo "$DETECTED_AMD" | grep -qiE 'Radeon Graphics$|Ryzen.*Radeon|Renoir|Cezanne|Barcelo|Phoenix|Rembrandt|Lucienne|Mendocino'; then
    GPU_TYPE="integrated"
    info "This appears to be an AMD APU (integrated graphics)"
else
    info "This appears to be an AMD discrete GPU"
fi

# ==============================================================================
# Package Selection
# ==============================================================================
header "Selecting Packages"

PACKAGES=(
    # Core Mesa drivers (OpenGL + VDPAU - merged since Mesa 24.2.7)
    "mesa"
    "lib32-mesa"

    # Vulkan support
    "vulkan-radeon"
    "lib32-vulkan-radeon"

    # VA-API hardware video acceleration
    "libva-mesa-driver"
    "lib32-libva-mesa-driver"

    # Vulkan utilities
    "vulkan-tools"

    # Wayland support
    "qt5-wayland"
    "qt6-wayland"
)

echo "Packages to install:"
for pkg in "${PACKAGES[@]}"; do
    echo "  - $pkg"
done
echo ""

# ==============================================================================
# Confirmation
# ==============================================================================
if [[ "$NONINTERACTIVE" != "1" ]]; then
    read -p "Continue with installation? [Y/n] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# ==============================================================================
# Package Installation
# ==============================================================================
header "Installing Packages"

# Check if multilib is enabled (required for lib32 packages)
PACMAN_CONF="$(target_path /etc/pacman.conf)"
if ! grep -q "^\[multilib\]" "$PACMAN_CONF"; then
    warn "Multilib repository is not enabled!"
    info "Enabling multilib repository for 32-bit support..."

    sed -i '/^#\[multilib\]/,/^#Include/ s/^#//' "$PACMAN_CONF"

    if ! grep -q "^\[multilib\]" "$PACMAN_CONF"; then
        warn "Could not auto-enable multilib. Adding it manually..."
        echo -e "\n[multilib]\nInclude = /etc/pacman.d/mirrorlist" >> "$PACMAN_CONF"
    fi

    info "Multilib repository enabled"
fi

info "Updating package database..."
run_cmd pacman -Syu --noconfirm

info "Installing AMD GPU packages..."
pkg_install "${PACKAGES[@]}"

# ==============================================================================
# ROCm (Optional) - only in interactive mode
# ==============================================================================
if [[ "$NONINTERACTIVE" != "1" ]] && [[ -z "$CHROOT_TARGET" ]]; then
    echo ""
    read -p "Install ROCm for GPU compute (OpenCL, HIP)? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        header "Installing ROCm"
        info "Installing ROCm packages..."
        pkg_install rocm-opencl-runtime rocm-hip-runtime
    fi
fi

# ==============================================================================
# Hyprland Configuration
# ==============================================================================
header "Configuring Hyprland Environment"

USER_HOME="$(get_user_home)"
HYPRLAND_CONF="$USER_HOME/.config/hypr/hyprland.conf"

if [[ -f "$HYPRLAND_CONF" ]]; then
    if grep -q "AMD environment" "$HYPRLAND_CONF"; then
        warn "AMD environment variables already present in hyprland.conf"
    else
        info "Adding AMD environment variables to hyprland.conf..."
        cat >>"$HYPRLAND_CONF" <<'EOF'

# ==============================================================================
# AMD environment variables
# ==============================================================================
env = LIBVA_DRIVER_NAME,radeonsi

# Electron/Chromium native Wayland support
env = ELECTRON_OZONE_PLATFORM_HINT,auto
EOF
        info "Environment variables added"
    fi
else
    warn "Hyprland config not found at $HYPRLAND_CONF"
    warn "Add these environment variables manually:"
    echo ""
    echo "  env = LIBVA_DRIVER_NAME,radeonsi"
    echo "  env = ELECTRON_OZONE_PLATFORM_HINT,auto"
fi

# ==============================================================================
# Completion
# ==============================================================================
header "Setup Complete"

info "AMD GPU setup complete!"
echo ""

if [[ -z "$CHROOT_TARGET" ]]; then
    echo "Verification commands:"
    echo "  vulkaninfo --summary      - Check Vulkan support"
    echo "  vainfo                    - Check VA-API (video acceleration)"
    echo "  glxinfo | grep renderer   - Check OpenGL renderer"
    echo ""

    if [[ "$GPU_TYPE" == "integrated" ]]; then
        echo "APU Notes:"
        echo "  - Your AMD APU handles all graphics"
        echo "  - No discrete GPU switching needed"
        echo "  - Power efficient for laptop use"
    fi
fi
