#!/usr/bin/env bash
# ==============================================================================
# AMD GPU Setup Script for Arch Linux
# ==============================================================================
# Installs AMD GPU drivers and Vulkan support.
# AMD GPUs use the open-source AMDGPU/Mesa stack by default.
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# --- GPU Detection ---
AMD_GPU=$(lspci | grep -iE 'vga|3d|display' | grep -iE 'amd|radeon|ati' || true)

if [ -z "$AMD_GPU" ]; then
    error "No AMD GPU detected. This script is only for AMD hardware."
fi

info "AMD GPU detected:"
echo "$AMD_GPU"
echo

# Determine GPU generation for driver selection
# GCN 1-4 (HD 7000+, R5/R7/R9, RX 400/500) and newer use AMDGPU
# Older (HD 6000 and below) use radeon driver (usually works out of box)

PACKAGES=(
    # Core Mesa drivers (OpenGL)
    "mesa"
    "lib32-mesa"

    # Vulkan support
    "vulkan-radeon"
    "lib32-vulkan-radeon"

    # VA-API hardware video acceleration
    "libva-mesa-driver"
    "lib32-libva-mesa-driver"

    # VDPAU video acceleration
    "mesa-vdpau"
    "lib32-mesa-vdpau"

    # Vulkan utilities
    "vulkan-tools"
)

info "The following packages will be installed:"
for pkg in "${PACKAGES[@]}"; do
    echo "  - $pkg"
done
echo

read -p "Continue? [Y/n] " -n 1 -r
echo
if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo "Aborted."
    exit 0
fi

# Install packages
info "Installing AMD GPU packages..."
sudo pacman -S --needed --noconfirm "${PACKAGES[@]}"

# Optional: Install ROCm for compute workloads
echo
read -p "Install ROCm for GPU compute (OpenCL, HIP)? [y/N] " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    info "Installing ROCm packages..."
    sudo pacman -S --needed --noconfirm rocm-opencl-runtime rocm-hip-runtime
fi

# Add environment variables for Hyprland
HYPRLAND_CONF="$HOME/.config/hypr/hyprland.conf"
if [ -f "$HYPRLAND_CONF" ]; then
    # Check if AMD vars already exist
    if ! grep -q "AMD environment" "$HYPRLAND_CONF"; then
        info "Adding AMD environment variables to hyprland.conf..."
        cat >>"$HYPRLAND_CONF" <<'EOF'

# AMD environment variables
env = LIBVA_DRIVER_NAME,radeonsi
EOF
    else
        info "AMD environment variables already configured in hyprland.conf"
    fi
fi

echo
info "AMD GPU setup complete!"
info "You can verify with:"
echo "  vulkaninfo --summary    - Check Vulkan support"
echo "  vainfo                  - Check VA-API support"
echo "  glxinfo | grep renderer - Check OpenGL renderer"
