#!/usr/bin/env bash
# ==============================================================================
# Bluetooth Setup Script for Arch Linux
# ==============================================================================
# Installs and enables Bluetooth support with a GUI management tool.
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

info "Bluetooth Setup"
echo

# Check for Bluetooth hardware
if ! lsusb | grep -qi bluetooth && ! lspci | grep -qi bluetooth; then
    warn "No Bluetooth hardware detected. Proceeding anyway..."
fi

# Packages to install
PACKAGES=(
    "bluez"           # Bluetooth protocol stack
    "bluez-utils"     # bluetoothctl and other utilities
    "blueman"         # GTK Bluetooth manager (tray applet)
)

info "The following packages will be installed:"
for pkg in "${PACKAGES[@]}"; do
    echo "  - $pkg"
done
echo

read -p "Continue? [Y/n] " -n 1 -r
echo
if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo "Aborted."
    exit 0
fi

# Install packages
info "Installing Bluetooth packages..."
sudo pacman -S --needed --noconfirm "${PACKAGES[@]}"

# Enable and start the Bluetooth service
info "Enabling Bluetooth service..."
sudo systemctl enable bluetooth.service
sudo systemctl start bluetooth.service

# Auto-power on Bluetooth adapter
info "Configuring Bluetooth to auto-power on..."
sudo sed -i 's/#AutoEnable=false/AutoEnable=true/' /etc/bluetooth/main.conf 2>/dev/null || \
    echo "AutoEnable=true" | sudo tee -a /etc/bluetooth/main.conf >/dev/null

echo
info "Bluetooth setup complete!"
info "You can use 'blueman-manager' for GUI or 'bluetoothctl' for CLI."
info "To pair a device: bluetoothctl -> scan on -> pair <MAC> -> connect <MAC>"
