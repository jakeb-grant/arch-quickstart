#!/usr/bin/env bash
# ==============================================================================
# Bluetooth Setup Script for Arch Linux
# ==============================================================================
# Installs and enables Bluetooth support with a GUI management tool.
#
# Environment variables for chroot-aware operation:
#   CHROOT_TARGET  - Target mount point (e.g., "/mnt") for installer mode
#   NONINTERACTIVE - Skip confirmation prompts when set to "1"
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# =============================================================================
# Chroot-aware helper functions
# =============================================================================

# Run a command - either directly with sudo, or via arch-chroot
run_cmd() {
    if [[ -n "$CHROOT_TARGET" ]]; then
        arch-chroot "$CHROOT_TARGET" "$@"
    else
        sudo "$@"
    fi
}

# Install packages
pkg_install() {
    run_cmd pacman -S --needed --noconfirm "$@"
}

# Enable a systemd service
svc_enable() {
    run_cmd systemctl enable "$@"
}

# Start a systemd service (only in non-chroot mode)
svc_start() {
    if [[ -z "$CHROOT_TARGET" ]]; then
        sudo systemctl start "$@"
    fi
}

# Get the correct file path (prefixed with CHROOT_TARGET if set)
target_path() {
    echo "${CHROOT_TARGET}$1"
}

# =============================================================================
# Main Script
# =============================================================================

info "Bluetooth Setup"
echo

# Check for Bluetooth hardware (only in non-chroot mode)
if [[ -z "$CHROOT_TARGET" ]]; then
    if ! lsusb | grep -qi bluetooth && ! lspci | grep -qi bluetooth; then
        warn "No Bluetooth hardware detected. Proceeding anyway..."
    fi
fi

# Packages to install
PACKAGES=(
    "bluez"           # Bluetooth protocol stack
    "bluez-utils"     # bluetoothctl and other utilities
    "blueman"         # GTK Bluetooth manager (tray applet)
)

info "The following packages will be installed:"
for pkg in "${PACKAGES[@]}"; do
    echo "  - $pkg"
done
echo

# Skip confirmation in non-interactive mode
if [[ "$NONINTERACTIVE" != "1" ]]; then
    read -p "Continue? [Y/n] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# Install packages
info "Installing Bluetooth packages..."
pkg_install "${PACKAGES[@]}"

# Enable and start the Bluetooth service
info "Enabling Bluetooth service..."
svc_enable bluetooth.service
svc_start bluetooth.service

# Auto-power on Bluetooth adapter
info "Configuring Bluetooth to auto-power on..."
BLUETOOTH_CONF="$(target_path /etc/bluetooth/main.conf)"
if [[ -f "$BLUETOOTH_CONF" ]]; then
    sed -i 's/#AutoEnable=false/AutoEnable=true/' "$BLUETOOTH_CONF"
    # If the setting doesn't exist, add it
    if ! grep -q "^AutoEnable=true" "$BLUETOOTH_CONF"; then
        echo "AutoEnable=true" >> "$BLUETOOTH_CONF"
    fi
fi

echo
info "Bluetooth setup complete!"
if [[ -z "$CHROOT_TARGET" ]]; then
    info "You can use 'blueman-manager' for GUI or 'bluetoothctl' for CLI."
    info "To pair a device: bluetoothctl -> scan on -> pair <MAC> -> connect <MAC>"
fi
