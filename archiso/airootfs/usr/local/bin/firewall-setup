#!/usr/bin/env bash
# ==============================================================================
# Firewall Setup Script for Arch Linux
# ==============================================================================
# Installs and configures UFW (Uncomplicated Firewall).
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

info "Firewall Setup (UFW)"
echo

# Check if already installed
if command -v ufw &>/dev/null; then
    info "UFW is already installed."
    ufw status
    echo
    read -p "Reconfigure UFW? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 0
    fi
fi

# Install UFW
info "Installing UFW..."
sudo pacman -S --needed --noconfirm ufw

# Reset to defaults
info "Resetting UFW to defaults..."
sudo ufw --force reset

# Set default policies
info "Setting default policies (deny incoming, allow outgoing)..."
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Common rules
echo
info "Select additional rules to enable:"
echo

# SSH
read -p "Allow SSH (port 22)? [y/N] " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    sudo ufw allow ssh
    info "SSH allowed"
fi

# HTTP/HTTPS
read -p "Allow HTTP/HTTPS (ports 80, 443)? [y/N] " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    sudo ufw allow http
    sudo ufw allow https
    info "HTTP/HTTPS allowed"
fi

# KDE Connect / GSConnect
read -p "Allow KDE Connect / GSConnect (ports 1714-1764)? [y/N] " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    sudo ufw allow 1714:1764/udp
    sudo ufw allow 1714:1764/tcp
    info "KDE Connect ports allowed"
fi

# Enable the firewall
echo
info "Enabling UFW..."
sudo systemctl enable ufw.service
sudo ufw --force enable

echo
info "Firewall setup complete!"
echo
sudo ufw status verbose
echo
info "Useful commands:"
echo "  ufw status          - Show current rules"
echo "  ufw allow <port>    - Allow a port"
echo "  ufw deny <port>     - Deny a port"
echo "  ufw delete <rule>   - Delete a rule"
