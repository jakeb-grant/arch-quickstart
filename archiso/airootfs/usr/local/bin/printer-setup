#!/usr/bin/env bash
# ==============================================================================
# Printer Setup Script for Arch Linux
# ==============================================================================
# Installs CUPS printing system and common drivers.
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

info "Printer Setup (CUPS)"
echo

# Packages to install
PACKAGES=(
    "cups"                    # CUPS printing system
    "cups-pdf"                # PDF virtual printer
    "ghostscript"             # PostScript interpreter
    "gsfonts"                 # Ghostscript fonts
    "gutenprint"              # Many printer drivers
    "foomatic-db-engine"      # Foomatic printer database
    "foomatic-db"             # Foomatic printer data
    "foomatic-db-ppds"        # PPD files
    "foomatic-db-nonfree"     # Non-free PPDs
    "foomatic-db-nonfree-ppds" # Non-free PPD files
    "system-config-printer"   # GTK printer configuration tool
)

info "The following packages will be installed:"
for pkg in "${PACKAGES[@]}"; do
    echo "  - $pkg"
done
echo

warn "This will install ~200MB of packages."
read -p "Continue? [Y/n] " -n 1 -r
echo
if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo "Aborted."
    exit 0
fi

# Install packages
info "Installing printing packages..."
sudo pacman -S --needed --noconfirm "${PACKAGES[@]}"

# Enable and start CUPS service
info "Enabling CUPS service..."
sudo systemctl enable cups.service
sudo systemctl start cups.service

# Add current user to lp group for printer access
CURRENT_USER=$(whoami)
if [[ "$CURRENT_USER" != "root" ]]; then
    info "Adding $CURRENT_USER to lp group..."
    sudo usermod -aG lp "$CURRENT_USER"
fi

echo
info "Printer setup complete!"
info "Web interface: http://localhost:631"
info "GUI tool: system-config-printer"
info "You may need to log out and back in for group changes to take effect."
