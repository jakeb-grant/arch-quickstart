#!/usr/bin/env bash
# ==============================================================================
# Dotfiles Setup Script
# ==============================================================================
# Clone and apply your personal dotfiles.
#
# TODO: Configure this script with your dotfiles repository.
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# =============================================================================
# CONFIGURATION - Edit these values
# =============================================================================

# Your dotfiles repository (SSH or HTTPS)
DOTFILES_REPO=""
# Example: DOTFILES_REPO="https://github.com/username/dotfiles.git"
# Example: DOTFILES_REPO="git@github.com:username/dotfiles.git"

# Where to clone the dotfiles
DOTFILES_DIR="$HOME/.dotfiles"

# Installation method: "stow", "symlink", or "script"
# - stow: Uses GNU stow to manage symlinks
# - symlink: Manually creates symlinks for common configs
# - script: Runs an install script from the repo (install.sh)
INSTALL_METHOD="script"

# =============================================================================

info "Dotfiles Setup"
echo

# Check if configured
if [[ -z "$DOTFILES_REPO" ]]; then
    warn "This script is not configured yet!"
    echo
    echo "To configure, edit this script and set:"
    echo "  DOTFILES_REPO - Your dotfiles git repository URL"
    echo "  INSTALL_METHOD - How to install (stow/symlink/script)"
    echo
    echo "Script location: $(readlink -f "$0")"
    exit 1
fi

# Check if already cloned
if [[ -d "$DOTFILES_DIR" ]]; then
    warn "Dotfiles directory already exists: $DOTFILES_DIR"
    read -p "Pull latest changes? [Y/n] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        info "Pulling latest changes..."
        git -C "$DOTFILES_DIR" pull
    fi
else
    # Clone the repository
    info "Cloning dotfiles from $DOTFILES_REPO..."
    git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
fi

# Install dotfiles based on method
case "$INSTALL_METHOD" in
    stow)
        info "Installing with GNU Stow..."
        if ! command -v stow &>/dev/null; then
            sudo pacman -S --needed --noconfirm stow
        fi
        cd "$DOTFILES_DIR"
        # Stow all directories (each subdir is a package)
        for dir in */; do
            stow -v "$dir"
        done
        ;;
    symlink)
        info "Creating symlinks..."
        # Common config directories to link
        configs=(
            ".config/hypr"
            ".config/waybar"
            ".config/rofi"
            ".config/ghostty"
            ".config/zed"
            ".zshrc"
            ".bashrc"
        )
        for config in "${configs[@]}"; do
            src="$DOTFILES_DIR/$config"
            dest="$HOME/$config"
            if [[ -e "$src" ]]; then
                mkdir -p "$(dirname "$dest")"
                ln -sfv "$src" "$dest"
            fi
        done
        ;;
    script)
        info "Running install script..."
        if [[ -x "$DOTFILES_DIR/install.sh" ]]; then
            cd "$DOTFILES_DIR"
            ./install.sh
        elif [[ -f "$DOTFILES_DIR/install.sh" ]]; then
            cd "$DOTFILES_DIR"
            bash install.sh
        else
            warn "No install.sh found in dotfiles repo"
            exit 1
        fi
        ;;
    *)
        error "Unknown install method: $INSTALL_METHOD"
        ;;
esac

echo
info "Dotfiles setup complete!"
