#!/usr/bin/env bash
# ==============================================================================
# Dotfiles Setup Script (chezmoi)
# ==============================================================================
# Initialize and apply dotfiles using chezmoi.
#
# Usage:
#   dotfiles-setup                    # Uses configured default repo
#   dotfiles-setup <repo>             # Uses specified repo
#   dotfiles-setup --hierarchical <main-repo> <extra-repo>  # Multiple repos
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# =============================================================================
# CONFIGURATION
# =============================================================================

# Default dotfiles repository (leave empty to require argument)
DEFAULT_REPO=""
# Example: DEFAULT_REPO="https://github.com/username/dotfiles.git"

# =============================================================================

info "Dotfiles Setup (chezmoi)"
echo

# Check if chezmoi is installed
if ! command -v chezmoi &>/dev/null; then
    error "chezmoi is not installed!"
fi

# Determine repo to use
REPO="${1:-$DEFAULT_REPO}"

if [[ -z "$REPO" ]]; then
    warn "No dotfiles repository specified!"
    echo
    echo "Usage:"
    echo "  dotfiles-setup <github-username>"
    echo "  dotfiles-setup <repo-url>"
    echo
    echo "Examples:"
    echo "  dotfiles-setup jakeb-grant"
    echo "  dotfiles-setup https://github.com/user/dotfiles.git"
    echo
    echo "Or edit this script to set DEFAULT_REPO"
    exit 1
fi

# Check if already initialized
if [[ -d "$HOME/.local/share/chezmoi" ]]; then
    warn "chezmoi already initialized"
    read -p "Re-apply dotfiles? [Y/n] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        info "Updating and applying dotfiles..."
        chezmoi update --apply
    fi
else
    # Initialize and apply
    info "Initializing chezmoi with $REPO..."
    chezmoi init "$REPO" --apply
fi

echo
info "Dotfiles setup complete!"
echo
echo "Useful chezmoi commands:"
echo "  chezmoi diff      - See pending changes"
echo "  chezmoi apply     - Apply changes"
echo "  chezmoi update    - Pull and apply latest"
echo "  chezmoi edit      - Edit managed files"
