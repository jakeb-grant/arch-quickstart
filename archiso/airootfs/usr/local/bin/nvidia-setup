#!/usr/bin/env bash
# ==============================================================================
# Hyprland NVIDIA Setup Script for Arch Linux
# ==============================================================================
# This script automates the installation and configuration of NVIDIA drivers
# for use with Hyprland on Arch Linux, following the official Hyprland wiki.
#
# Supports:
# - Dedicated NVIDIA GPUs (desktop)
# - Hybrid graphics (Intel iGPU + NVIDIA dGPU)
# - Hybrid graphics (AMD iGPU + NVIDIA dGPU)
# - PRIME render offloading for hybrid setups
#
# Environment variables for chroot-aware operation:
#   CHROOT_TARGET   - Target mount point (e.g., "/mnt") for installer mode
#   CHROOT_USER     - Username to configure (for hyprland.conf)
#   NONINTERACTIVE  - Skip confirmation prompts when set to "1"
#   DETECTED_NVIDIA - Pre-detected NVIDIA GPU info (skips detection)
#   DETECTED_INTEL  - Pre-detected Intel GPU info (for hybrid detection)
#   DETECTED_AMD    - Pre-detected AMD GPU info (for hybrid detection)
#
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
header() { echo -e "\n${CYAN}=== $1 ===${NC}\n"; }

# =============================================================================
# Chroot-aware helper functions
# =============================================================================

run_cmd() {
    if [[ -n "$CHROOT_TARGET" ]]; then
        arch-chroot "$CHROOT_TARGET" "$@"
    else
        sudo "$@"
    fi
}

pkg_install() {
    run_cmd pacman -S --needed --noconfirm "$@"
}

target_path() {
    echo "${CHROOT_TARGET}$1"
}

is_offline_mode() {
    # Check if running in offline mode (local repo, no internet mirrors)
    local conf="$(target_path /etc/pacman.conf)"
    grep -q "Server = file:///opt/offline-repo" "$conf" 2>/dev/null
}

# Check if an AUR helper is available
get_aur_helper() {
    if [[ -n "$CHROOT_TARGET" ]]; then
        if arch-chroot "$CHROOT_TARGET" which paru &>/dev/null 2>&1; then
            echo "paru"
        elif arch-chroot "$CHROOT_TARGET" which yay &>/dev/null 2>&1; then
            echo "yay"
        fi
    else
        if command -v paru &>/dev/null; then
            echo "paru"
        elif command -v yay &>/dev/null; then
            echo "yay"
        fi
    fi
}

# Install AUR packages (handles offline vs online mode)
# Usage: aur_install <package1> <package2> ...
aur_install() {
    local packages=("$@")

    if is_offline_mode; then
        # Offline mode: packages are pre-built in offline repo, use pacman
        info "Installing from offline repository..."
        pkg_install "${packages[@]}"
    else
        # Online mode: need AUR helper
        local aur_helper
        aur_helper=$(get_aur_helper)

        if [[ -z "$aur_helper" ]]; then
            echo ""
            error "No AUR helper found (paru or yay required for legacy NVIDIA drivers)"
        fi

        info "Installing via $aur_helper..."
        if [[ -n "$CHROOT_TARGET" ]]; then
            # In chroot: need to run as non-root user
            if [[ -z "$CHROOT_USER" ]]; then
                error "CHROOT_USER not set - cannot install AUR packages in chroot"
            fi
            arch-chroot "$CHROOT_TARGET" sudo -u "$CHROOT_USER" $aur_helper -S --noconfirm --needed "${packages[@]}"
        else
            # Normal system: check if running as root
            if [[ $EUID -eq 0 ]]; then
                # Running as root (via sudo), get the original user
                if [[ -n "$SUDO_USER" ]]; then
                    sudo -u "$SUDO_USER" $aur_helper -S --noconfirm --needed "${packages[@]}"
                else
                    error "Cannot install AUR packages as root. Run nvidia-setup with sudo as a normal user."
                fi
            else
                $aur_helper -S --noconfirm --needed "${packages[@]}"
            fi
        fi
    fi
}

# Get the user's home directory path
get_user_home() {
    if [[ -n "$CHROOT_USER" ]]; then
        echo "${CHROOT_TARGET}/home/$CHROOT_USER"
    elif [[ -n "$SUDO_USER" ]]; then
        echo "/home/$SUDO_USER"
    else
        echo "$HOME"
    fi
}

# ==============================================================================
# GPU Detection
# ==============================================================================
header "Detecting Graphics Hardware"

# Use pre-detected GPUs if provided via environment, otherwise detect
if [[ -z "$DETECTED_NVIDIA" ]]; then
    ALL_GPUS=$(lspci | grep -iE 'vga|3d|display' || true)
    DETECTED_NVIDIA=$(echo "$ALL_GPUS" | grep -i 'nvidia' | head -1 || true)
    DETECTED_INTEL=$(echo "$ALL_GPUS" | grep -iE 'intel.*(graphics|hd|uhd|iris|xe)' | head -1 || true)
    DETECTED_AMD=$(echo "$ALL_GPUS" | grep -iE 'amd|radeon|ati' | head -1 || true)
fi

# Check if AMD GPU is an APU (integrated) or discrete
AMD_IS_IGPU=false
if [[ -n "$DETECTED_AMD" ]]; then
    # APU indicators: "Radeon Graphics" (without RX/Pro), "Vega" integrated, Ryzen integrated
    if echo "$DETECTED_AMD" | grep -qiE 'Radeon Graphics$|Ryzen.*Radeon|Renoir|Cezanne|Barcelo|Phoenix|Rembrandt|Lucienne|Mendocino'; then
        AMD_IS_IGPU=true
    fi
fi

# --- Validate NVIDIA GPU exists ---
if [[ -z "$DETECTED_NVIDIA" ]]; then
    echo ""
    warn "No NVIDIA GPU detected!"
    echo ""
    echo "Detected GPUs:"
    lspci | grep -iE 'vga|3d|display' | sed 's/^/  /' || echo "  None found"
    echo ""

    if [[ -n "$DETECTED_AMD" ]]; then
        info "AMD GPU detected. Run 'amd-setup' instead."
    elif [[ -n "$DETECTED_INTEL" ]]; then
        info "Intel GPU detected. Run 'intel-setup' instead."
    fi
    exit 1
fi

# --- Display detected hardware ---
info "NVIDIA GPU detected:"
echo "  $DETECTED_NVIDIA"

# Determine hybrid setup type
HYBRID_TYPE=""
if [[ -n "$DETECTED_INTEL" ]]; then
    HYBRID_TYPE="intel"
    info "Intel iGPU detected (hybrid graphics):"
    echo "  $DETECTED_INTEL"
elif [[ -n "$DETECTED_AMD" ]] && [[ "$AMD_IS_IGPU" == "true" ]]; then
    HYBRID_TYPE="amd"
    info "AMD iGPU/APU detected (hybrid graphics):"
    echo "  $DETECTED_AMD"
elif [[ -n "$DETECTED_AMD" ]] && [[ "$AMD_IS_IGPU" == "false" ]]; then
    warn "AMD discrete GPU also detected - multi-GPU setup:"
    echo "  $DETECTED_AMD"
    warn "This script will configure NVIDIA. AMD dGPU may need separate config."
fi

if [[ -z "$HYBRID_TYPE" ]]; then
    info "Dedicated NVIDIA setup (no integrated GPU detected)"
fi

# ==============================================================================
# Driver Selection
# ==============================================================================
header "Selecting Driver Package"

# GPU Generation Detection
#
# NVIDIA Driver 590+ Support Matrix:
#   - Turing and newer (GTX 16xx, RTX 20xx+): nvidia-open-dkms (official repo)
#   - Pascal and older (GTX 10xx, 9xx, etc.): nvidia-580xx-dkms (AUR - legacy)
#
# The open kernel modules are now the default for supported GPUs.

NVIDIA_DRIVER_PACKAGE=""
NVIDIA_UTILS_PACKAGE=""
LEGACY_GPU=false

# Check for Turing and newer (supported by driver 590+)
if echo "$DETECTED_NVIDIA" | grep -qiE 'RTX.*(50[0-9][0-9]|5090|5080|5070|5060|5050)'; then
    # Blackwell (50xx)
    NVIDIA_DRIVER_PACKAGE="nvidia-open-dkms"
    NVIDIA_UTILS_PACKAGE="nvidia-utils"
    info "Detected Blackwell (50xx) GPU - nvidia-open-dkms"
elif echo "$DETECTED_NVIDIA" | grep -qiE 'RTX.*(40[0-9][0-9]|4090|4080|4070|4060|4050)'; then
    # Ada Lovelace (40xx)
    NVIDIA_DRIVER_PACKAGE="nvidia-open-dkms"
    NVIDIA_UTILS_PACKAGE="nvidia-utils"
    info "Detected Ada Lovelace (40xx) GPU - nvidia-open-dkms"
elif echo "$DETECTED_NVIDIA" | grep -qiE 'RTX.*(30[0-9][0-9]|3090|3080|3070|3060|3050)'; then
    # Ampere (30xx)
    NVIDIA_DRIVER_PACKAGE="nvidia-open-dkms"
    NVIDIA_UTILS_PACKAGE="nvidia-utils"
    info "Detected Ampere (30xx) GPU - nvidia-open-dkms"
elif echo "$DETECTED_NVIDIA" | grep -qiE 'RTX.*(20[0-9][0-9]|2080|2070|2060)|GTX.*(16[0-9][0-9]|1660|1650|1630)'; then
    # Turing (20xx and GTX 16xx)
    NVIDIA_DRIVER_PACKAGE="nvidia-open-dkms"
    NVIDIA_UTILS_PACKAGE="nvidia-utils"
    info "Detected Turing (20xx/16xx) GPU - nvidia-open-dkms"
elif echo "$DETECTED_NVIDIA" | grep -qiE 'GTX.*(10[0-9][0-9]|1080|1070|1060|1050|1030)|GT.?10[0-9][0-9]'; then
    # Pascal (10xx) - LEGACY
    NVIDIA_DRIVER_PACKAGE="nvidia-580xx-dkms"
    NVIDIA_UTILS_PACKAGE="nvidia-580xx-utils"
    LEGACY_GPU=true
    warn "Detected Pascal (10xx) GPU - LEGACY driver required"
elif echo "$DETECTED_NVIDIA" | grep -qiE 'GTX.*(9[0-9][0-9]|980|970|960|950)|GT.?9[0-9][0-9]'; then
    # Maxwell (9xx) - LEGACY
    NVIDIA_DRIVER_PACKAGE="nvidia-580xx-dkms"
    NVIDIA_UTILS_PACKAGE="nvidia-580xx-utils"
    LEGACY_GPU=true
    warn "Detected Maxwell (9xx) GPU - LEGACY driver required"
elif echo "$DETECTED_NVIDIA" | grep -qiE 'RTX'; then
    # Unknown RTX - assume modern
    NVIDIA_DRIVER_PACKAGE="nvidia-open-dkms"
    NVIDIA_UTILS_PACKAGE="nvidia-utils"
    info "Detected RTX GPU - nvidia-open-dkms"
else
    # Older/unrecognized - LEGACY
    NVIDIA_DRIVER_PACKAGE="nvidia-580xx-dkms"
    NVIDIA_UTILS_PACKAGE="nvidia-580xx-utils"
    LEGACY_GPU=true
    warn "Detected older/unrecognized GPU - LEGACY driver required"
fi

# Display legacy GPU warning and check requirements
if [[ "$LEGACY_GPU" == "true" ]]; then
    echo ""
    warn "════════════════════════════════════════════════════════════════"
    warn "  LEGACY GPU DETECTED"
    warn "════════════════════════════════════════════════════════════════"
    echo ""
    echo "  NVIDIA driver 590+ no longer supports your GPU."
    echo "  The legacy nvidia-580xx driver from AUR will be installed."
    echo ""
    echo "  GPU: $(echo "$DETECTED_NVIDIA" | sed 's/.*: //')"
    echo "  Driver: $NVIDIA_DRIVER_PACKAGE (AUR)"
    echo ""

    # Check requirements for online mode (not in offline mode)
    if ! is_offline_mode; then
        AUR_HELPER=$(get_aur_helper)
        if [[ -z "$AUR_HELPER" ]]; then
            warn "════════════════════════════════════════════════════════════════"
            echo ""
            echo "  No AUR helper found!"
            echo ""
            echo "  Legacy NVIDIA drivers require an AUR helper (paru or yay)."
            echo ""
            echo "  Install one first:"
            echo "    sudo pacman -S paru   (or yay)"
            echo ""
            echo "  Then run nvidia-setup again."
            echo ""
            exit 1
        fi
        info "AUR helper found: $AUR_HELPER"
    fi
    warn "════════════════════════════════════════════════════════════════"
    echo ""
fi

# Check which kernel is installed and set appropriate headers package
KERNEL_HEADERS="linux-headers"  # Default

if [[ -z "$CHROOT_TARGET" ]]; then
    # Running on live system - check installed kernels
    if pacman -Q linux-zen &>/dev/null; then
        KERNEL_HEADERS="linux-zen-headers"
        info "Detected linux-zen kernel"
    elif pacman -Q linux-lts &>/dev/null; then
        KERNEL_HEADERS="linux-lts-headers"
        info "Detected linux-lts kernel"
    elif pacman -Q linux-hardened &>/dev/null; then
        KERNEL_HEADERS="linux-hardened-headers"
        info "Detected linux-hardened kernel"
    else
        info "Using default linux kernel headers"
    fi
else
    # In chroot - check target system
    if run_cmd pacman -Q linux-zen &>/dev/null 2>&1; then
        KERNEL_HEADERS="linux-zen-headers"
    elif run_cmd pacman -Q linux-lts &>/dev/null 2>&1; then
        KERNEL_HEADERS="linux-lts-headers"
    elif run_cmd pacman -Q linux-hardened &>/dev/null 2>&1; then
        KERNEL_HEADERS="linux-hardened-headers"
    fi
fi

# ==============================================================================
# Summary and Confirmation
# ==============================================================================
header "Installation Summary"

echo "Hardware detected:"
echo "  - NVIDIA GPU: $(echo "$DETECTED_NVIDIA" | sed 's/.*: //')"
if [[ -n "$HYBRID_TYPE" ]]; then
    if [[ "$HYBRID_TYPE" == "intel" ]]; then
        echo "  - Intel iGPU: $(echo "$DETECTED_INTEL" | sed 's/.*: //')"
    else
        echo "  - AMD iGPU: $(echo "$DETECTED_AMD" | sed 's/.*: //')"
    fi
    echo "  - Setup type: Hybrid (PRIME offloading)"
else
    echo "  - Setup type: Dedicated NVIDIA"
fi
echo ""

if [[ "$LEGACY_GPU" == "true" ]]; then
    echo "Driver information:"
    echo "  - Status: LEGACY GPU (not supported by driver 590+)"
    echo "  - Driver: $NVIDIA_DRIVER_PACKAGE (AUR)"
    echo "  - Utils: $NVIDIA_UTILS_PACKAGE, lib32-$NVIDIA_UTILS_PACKAGE"
    echo "  - Headers: $KERNEL_HEADERS"
    if is_offline_mode; then
        echo "  - Source: Offline repository (pre-built)"
    else
        echo "  - Source: AUR via $(get_aur_helper)"
    fi
else
    echo "Packages to install:"
    echo "  - Driver: $NVIDIA_DRIVER_PACKAGE"
    echo "  - Headers: $KERNEL_HEADERS"
    echo "  - Utils: nvidia-utils, lib32-nvidia-utils"
    echo "  - Wayland: egl-wayland, libva-nvidia-driver"
fi
echo ""

echo "System modifications:"
echo "  - /etc/modprobe.d/nvidia.conf (DRM modeset)"
echo "  - /etc/mkinitcpio.conf (early KMS modules)"
echo "  - ~/.config/hypr/hyprland.conf (environment variables)"
if [[ -n "$HYBRID_TYPE" ]]; then
    echo "  - /usr/local/bin/prime-run (PRIME wrapper script)"
fi

if [[ "$NONINTERACTIVE" != "1" ]]; then
    echo ""
    warn "This will modify system configuration files."
    read -p "Continue? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# ==============================================================================
# Package Installation
# ==============================================================================
header "Installing Packages"

# Check if we're in offline mode (packages pre-installed in local repo)
if is_offline_mode; then
    info "Offline mode detected - using local package repository"
    info "Skipping database sync (packages already available locally)"
else
    # Online mode: ensure multilib is enabled and sync databases
    PACMAN_CONF="$(target_path /etc/pacman.conf)"
    if ! grep -q "^\[multilib\]" "$PACMAN_CONF"; then
        warn "Multilib repository is not enabled!"
        info "Enabling multilib repository for 32-bit support..."

        # Enable multilib by uncommenting the section
        sed -i '/^#\[multilib\]/,/^#Include/ s/^#//' "$PACMAN_CONF"

        # Verify it was enabled
        if ! grep -q "^\[multilib\]" "$PACMAN_CONF"; then
            warn "Could not auto-enable multilib. Adding it manually..."
            echo -e "\n[multilib]\nInclude = /etc/pacman.d/mirrorlist" >> "$PACMAN_CONF"
        fi

        info "Multilib repository enabled"
    fi

    info "Updating package database..."
    run_cmd pacman -Syu --noconfirm
fi

# Build package lists based on GPU type
if [[ "$LEGACY_GPU" == "true" ]]; then
    # Legacy GPU: AUR driver packages + official support packages
    AUR_DRIVER_PACKAGES=(
        "${NVIDIA_DRIVER_PACKAGE}"          # nvidia-580xx-dkms
        "${NVIDIA_UTILS_PACKAGE}"           # nvidia-580xx-utils
        "lib32-${NVIDIA_UTILS_PACKAGE}"     # lib32-nvidia-580xx-utils
        "nvidia-580xx-settings"             # GUI configuration tool
    )

    OFFICIAL_PACKAGES=(
        "${KERNEL_HEADERS}"
        "egl-wayland"
        "qt5-wayland"
        "qt6-wayland"
    )

    # Install official packages first
    info "Installing official packages..."
    echo "  Packages: ${OFFICIAL_PACKAGES[*]}"
    echo ""
    pkg_install "${OFFICIAL_PACKAGES[@]}"

    # Install AUR driver packages (handles offline vs online)
    info "Installing legacy NVIDIA driver packages..."
    echo "  Packages: ${AUR_DRIVER_PACKAGES[*]}"
    echo ""
    aur_install "${AUR_DRIVER_PACKAGES[@]}"
else
    # Modern GPU: all official packages
    PACKAGES_TO_INSTALL=(
        "${KERNEL_HEADERS}"
        "${NVIDIA_DRIVER_PACKAGE}"          # nvidia-open-dkms
        "nvidia-utils"
        "lib32-nvidia-utils"
        "egl-wayland"
        "libva-nvidia-driver"               # VA-API hardware video acceleration
        "nvidia-settings"                   # GUI configuration tool
        "qt5-wayland"
        "qt6-wayland"
    )

    info "Installing NVIDIA packages..."
    echo "  Packages: ${PACKAGES_TO_INSTALL[*]}"
    echo ""
    pkg_install "${PACKAGES_TO_INSTALL[@]}"
fi

# ==============================================================================
# Modprobe Configuration
# ==============================================================================
header "Configuring Kernel Modules"

info "Creating /etc/modprobe.d/nvidia.conf..."
echo "options nvidia_drm modeset=1" > "$(target_path /etc/modprobe.d/nvidia.conf)"

# ==============================================================================
# Mkinitcpio Configuration
# ==============================================================================
MKINITCPIO_CONF="$(target_path /etc/mkinitcpio.conf)"

# Create backup with timestamp
BACKUP_FILE="${MKINITCPIO_CONF}.backup.$(date +%Y%m%d%H%M%S)"
info "Backing up mkinitcpio.conf to $BACKUP_FILE..."
cp "$MKINITCPIO_CONF" "$BACKUP_FILE"

# Build modules list based on hybrid type
# Critical: For Intel hybrid, i915 MUST come BEFORE nvidia modules
# This prevents Electron/Chromium apps from stalling up to 1 minute on boot
if [[ "$HYBRID_TYPE" == "intel" ]]; then
    MODULES_TO_ADD="i915 nvidia nvidia_modeset nvidia_uvm nvidia_drm"
    info "Intel hybrid: adding i915 BEFORE NVIDIA modules"
    info "  (Prevents Electron/Chromium boot stalling)"
elif [[ "$HYBRID_TYPE" == "amd" ]]; then
    MODULES_TO_ADD="amdgpu nvidia nvidia_modeset nvidia_uvm nvidia_drm"
    info "AMD hybrid: adding amdgpu BEFORE NVIDIA modules"
else
    MODULES_TO_ADD="nvidia nvidia_modeset nvidia_uvm nvidia_drm"
    info "Dedicated NVIDIA: adding NVIDIA modules only"
fi

# Remove any existing nvidia/igpu modules to prevent duplicates
info "Configuring mkinitcpio for early KMS..."
sed -i -E 's/ ?nvidia_drm//g; s/ ?nvidia_uvm//g; s/ ?nvidia_modeset//g; s/ ?nvidia( |$)/ /g; s/ ?i915//g; s/ ?amdgpu//g;' "$MKINITCPIO_CONF"

# Add modules at the start of the MODULES array
sed -i -E "s/^(MODULES=\\()/\\1${MODULES_TO_ADD} /" "$MKINITCPIO_CONF"

# Clean up formatting
sed -i -E 's/MODULES=\( +/MODULES=(/g; s/  +/ /g; s/ \)/)/g' "$MKINITCPIO_CONF"

info "Regenerating initramfs..."
run_cmd mkinitcpio -P

# ==============================================================================
# PRIME Offloading (Hybrid Graphics Only)
# ==============================================================================
if [[ -n "$HYBRID_TYPE" ]]; then
    header "Setting Up PRIME Offloading"

    info "Creating /usr/local/bin/prime-run wrapper..."
    cat > "$(target_path /usr/local/bin/prime-run)" <<'EOF'
#!/bin/bash
# ==============================================================================
# PRIME Render Offload Wrapper
# ==============================================================================
# Run applications on the NVIDIA dGPU in hybrid graphics systems.
#
# Usage: prime-run <application> [arguments]
#
# Examples:
#   prime-run glxinfo | grep "OpenGL renderer"
#   prime-run steam
#   prime-run gamescope -- %command%
#
# ==============================================================================

export __NV_PRIME_RENDER_OFFLOAD=1
export __NV_PRIME_RENDER_OFFLOAD_PROVIDER=NVIDIA-G0
export __GLX_VENDOR_LIBRARY_NAME=nvidia
export __VK_LAYER_NV_optimus=NVIDIA_only

exec "$@"
EOF
    chmod +x "$(target_path /usr/local/bin/prime-run)"

    info "prime-run wrapper installed!"
    echo "  Usage: prime-run <application>"
    echo "  Example: prime-run steam"
fi

# ==============================================================================
# Hyprland Configuration
# ==============================================================================
header "Configuring Hyprland Environment"

USER_HOME="$(get_user_home)"
HYPRLAND_CONF="$USER_HOME/.config/hypr/hyprland.conf"

if [[ -f "$HYPRLAND_CONF" ]]; then
    # Check if NVIDIA config already exists
    if grep -q "NVIDIA environment variables" "$HYPRLAND_CONF"; then
        warn "NVIDIA environment variables already present in hyprland.conf"
        warn "Skipping to avoid duplicates. Please verify configuration manually."
    else
        info "Adding NVIDIA environment variables to hyprland.conf..."

        if [[ -n "$HYBRID_TYPE" ]]; then
            # Hybrid graphics configuration
            cat >>"$HYPRLAND_CONF" <<'EOF'

# ==============================================================================
# NVIDIA environment variables (hybrid graphics)
# ==============================================================================
env = LIBVA_DRIVER_NAME,nvidia
env = __GLX_VENDOR_LIBRARY_NAME,nvidia
env = NVD_BACKEND,direct

# Electron/Chromium native Wayland support (reduces flickering)
env = ELECTRON_OZONE_PLATFORM_HINT,auto

# Uncomment below if you experience multi-monitor issues on hybrid graphics:
# env = AQ_DRM_DEVICES,/dev/dri/card1:/dev/dri/card0
EOF
        else
            # Dedicated NVIDIA configuration
            cat >>"$HYPRLAND_CONF" <<'EOF'

# ==============================================================================
# NVIDIA environment variables
# ==============================================================================
env = LIBVA_DRIVER_NAME,nvidia
env = __GLX_VENDOR_LIBRARY_NAME,nvidia
env = NVD_BACKEND,direct

# Electron/Chromium native Wayland support (reduces flickering)
env = ELECTRON_OZONE_PLATFORM_HINT,auto
EOF
        fi
        info "Environment variables added to hyprland.conf"
    fi
else
    warn "Hyprland config not found at $HYPRLAND_CONF"
    echo ""
    warn "Add these environment variables manually to your hyprland.conf:"
    echo ""
    echo "  env = LIBVA_DRIVER_NAME,nvidia"
    echo "  env = __GLX_VENDOR_LIBRARY_NAME,nvidia"
    echo "  env = NVD_BACKEND,direct"
    echo "  env = ELECTRON_OZONE_PLATFORM_HINT,auto"
    if [[ -n "$HYBRID_TYPE" ]]; then
        echo ""
        echo "  # For multi-monitor issues on hybrid graphics:"
        echo "  # env = AQ_DRM_DEVICES,/dev/dri/card1:/dev/dri/card0"
    fi
fi

# ==============================================================================
# Completion
# ==============================================================================
header "Setup Complete"

info "NVIDIA setup complete!"
echo ""

if [[ -z "$CHROOT_TARGET" ]]; then
    echo "Verification steps after reboot:"
    echo "  1. nvidia-smi                                      - Check driver loaded"
    echo "  2. cat /sys/module/nvidia_drm/parameters/modeset   - Should return 'Y'"
    if [[ -n "$HYBRID_TYPE" ]]; then
        echo "  3. prime-run glxinfo | grep 'OpenGL renderer'      - Test PRIME offload"
    fi
    echo ""

    if [[ -n "$HYBRID_TYPE" ]]; then
        echo "Hybrid graphics usage:"
        echo "  - Apps run on ${HYBRID_TYPE} iGPU by default (power saving)"
        echo "  - Use 'prime-run <app>' to run on NVIDIA dGPU"
        echo "  - Example: prime-run steam"
        echo ""
        echo "Troubleshooting:"
        echo "  - Multi-monitor issues? Try: env = AQ_DRM_DEVICES,/dev/dri/card1:/dev/dri/card0"
        echo "  - Electron apps slow to start? Verify i915/amdgpu is BEFORE nvidia in mkinitcpio"
        echo ""
    fi

    warn "A reboot is required for changes to take effect."
    echo ""
    read -p "Reboot now? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        sudo reboot
    fi
fi
